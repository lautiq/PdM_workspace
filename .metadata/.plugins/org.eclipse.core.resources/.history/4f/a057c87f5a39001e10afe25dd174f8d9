/*
 * API_SSD1306.c
 *
 *  Created on: Aug 05, 2023
 *      Author: Lautaro Quarin
 */


#include "API_SSD1306.h"

// Screenbuffer
static uint8_t SSD1306_Buffer[SSD1306_BUFFER_SIZE];

// Screen object
static SSD1306_t SSD1306;

void ssd1306_WriteCommand(uint8_t byte)
{
	//HAL function information: HAL_I2C_Mem_Write(hi2c, DevAddress, MemAddress, MemAddSize, pData, Size, Timeout);

	HAL_I2C_Mem_Write(SSD1306_I2C_PORT, SSD1306_I2C_ADDR, SSD1306_COMMAND_STREAM, 1, &byte, 1, HAL_MAX_DELAY);

}

void ssd1306_WriteData(uint8_t* buffer, size_t buff_size)
{
	HAL_I2C_MemWrite(SSD1306_I2C_PORT, SSD1306_I2C_ADDR, SSD1306_DATA_STREAM, 1, buffer, buff_size, HAL_MAX_DELAY);
}

void ssd1306_Init()
{

	//Time delay for the screen boot
	HAL_Delay(100);

	//Init OLED
	ssd1306_SetDisplayOn(0);

	ssd1306_WriteCommand(SSD1306_MEMORY_ADDR_MODE); //0x20 set memory addressing mode
	ssd1306_WriteCommand(0x00); // 00b Horizontal addressing Mode, 01b Vertical addressing mode, 10b page addressing mode.

	ssd1306_WriteCommand(0xB0); // 0xB0 Set page Start Address for page addressing mode 0-7.

	ssd1306_WriteCommand(SSD1306_COM_SCAN_DIR_OP); //0xC8 Set COM Output Scan Direction

	ssd1306_WriteCommand(0x00); //0x0 set low column address
	ssd1306_WriteCommand(0x10); //0x10 set high column address

	ssd1306_WriteCommand(SSD1306_SET_START_LINE); // 0x40 set start line address

	//SetContrast(0xFF);
	ssd1306_WriteCommand(SSD1306_SET_CONTRAST);
	ssd1308_WriteCommand(0xFF);

	ssd1306_WriteCommand(SSD1306_SEG_REMAP_OP); //0xA1 set segment re-map 0 to 127

	ssd1306_WriteCommand(SD1306_DIS_NORMAL); //0xA6 set normal color



	ssd1306_WriteCommand(SSD1306_SET_MUX_RATIO); //0xA8 set multiplex ratio to 1-64
	ssd1306_WriteCommand(0x3F); // Set multiplex ratio for 128px high

	ssd1306_WriteCommand(SSD1306_DIS_ENT_DISP_ON); //0xA4 Output follows RAM content.

	ssd1306_WriteCommand(SSD1306_DISPLAY_OFFSET); //0xD3 display offset
	ssd1306_WriteCommand(0x00);					//Not offset

	ssd1306_WriteCommand(SSD1306_SET_OSC_FREQ); //0xD5 set display clock divide ratio/oscilator freq
	ssd1306_WriteCommand(0xF0);		//Set divide ratio.

	ssd1306_WriteCommand(SSD1306_SET_PRECHARGE);	//0xD9 Set pre-charged period
	ssd1306_WriteCommand(0x22);	//Set period.

	ssd1306_WriteCommand(SSD1306_COM_PIN_CONF); //0xDA set com pins hardware config
	ssd1306_WriteCommand(0x12);	//64px height

    ssd1306_WriteCommand(SSD1306_VCOM_DESELECT); // set vcomh
    ssd1306_WriteCommand(0x20); //0x20,0.77xVcc

    ssd1306_WriteCommand(SSD1306_SET_CHAR_REG); //DC-DC ENABLE
    ssd1306_WriteCommand(0x14);
ssd1306_SetDisplayOn(1);

ssd1306_Fill(BLACK);

}





void ssd1306_SetDisplayOn(const uint8_t on)
{
	uint8_t command;
	if(on)
	{
		//Display on
		SSD1306.DisplayOn = 1;
		command = SSD1306_DISPLAY_ON; //0xAF
	} else
	{
		//Display off
		SSD1306.DisplayOn = 0;
		command = SSD1306_DISPLAY_OFF; //0xAE
	}
	ssd1306_WriteCommand(command);
}
